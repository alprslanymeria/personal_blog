version: '3.8'
services:

  elasticsearch:
    image: elasticsearch:9.1.4
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false

  kibana:
    image: kibana:9.1.4
    container_name: kibana
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    ports:
      - "5601:5601"
    depends_on:
      - elasticsearch

  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: jaeger
    ports:
      - "16686:16686" # UI

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    depends_on:
      - otel-collector

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "4000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - blog-app-grafana-data:/var/lib/grafana
    depends_on:
      - prometheus

  otel-collector:
    image: otel/opentelemetry-collector-contrib
    container_name: otel-collector
    volumes:
      - ./otel-collector-config.yaml:/etc/otelcol-contrib/config.yaml

  nextjs:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: app
    ports:
      - "3000:3000"
    env_file:
      - .env
      - .env.local
    depends_on:
      - elasticsearch
      - jaeger
      - otel-collector
      - sqlserver
    environment:
      NODE_ENV: production
      NEXT_TELEMETRY_DISABLED: 1
    volumes:
      - ./personal-blog-451512-20042f173e6d.json:/app/gcp-key.json:ro # HOST:DOCKER:PERMISSIONS
    restart: unless-stopped

  
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: sqlserver
    ports:
      - "1430:1433"
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: "iA69754."
    volumes:
      - blog-app-sqlserver-data:/var/opt/mssql   # Verilerin kalıcı olacağı volume HOST:DOCKER:PERMISSIONS
    restart: unless-stopped

volumes:
  blog-app-grafana-data:
  blog-app-sqlserver-data:


# | Port     | Amaç                                      | Erişen                    | Açıklama                                     |
# | -------- | ----------------------------------------- | ------------------------- | -------------------------------------------- |
# | **4317** | OTLP gRPC receiver                        | Uygulama (Next.js)        | Trace + metric verilerini Collector’a yollar |
# | **4318** | OTLP HTTP receiver                        | Alternatif HTTP protokolü | (kullanmak zorunda değilsin)                 |
# | **8888** | Collector’un *kendi* metrikleri           | Prometheus (isteğe bağlı) | Collector’un iç durumu                       |
# | **8889** | Uygulama metriklerinin Prometheus formatı | Prometheus                | Asıl scrape edilen metrik endpoint           |